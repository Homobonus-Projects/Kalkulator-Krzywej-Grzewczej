<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wizualizator Krzywej Grzewczej De Dietrich (AD289)</title>
    <!-- Ładowanie Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Ładowanie Chart.js dla wykresu -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /* Konfiguracja czcionki Inter */
        body { font-family: 'Inter', sans-serif; }
        /* Styl dla czystego wyglądu canvas */
        .chart-container {
            position: relative;
            height: 60vh;
            width: 100%;
            min-height: 400px;
        }
        /* Dostosowanie paska do mobilnego widoku */
        @media (min-width: 1024px) {
            .chart-container {
                height: 70vh;
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <!-- Kontener Główny -->
    <div class="max-w-6xl mx-auto p-4 md:p-8">

        <h1 class="3xl font-extrabold text-blue-800 mb-2 border-b-2 pb-2">
            ⚙️ Wizualizator Krzywej Grzewczej (i-Sense)
        </h1>
        <p class="text-gray-600 mb-6">
            Ustaw parametry, aby zobaczyć optymalną krzywą grzewczą Twojego kotła kondensacyjnego.
        </p>

        <!-- Sekcja Formularza i Parametrów -->
        <div class="grid lg:grid-cols-3 gap-6 mb-8 bg-white p-6 rounded-xl shadow-lg">

            <!-- Wprowadzanie Danych -->
            <div class="lg:col-span-1 space-y-4">
                <h2 class="text-xl font-semibold text-blue-700 border-b pb-2 mb-4">Parametry Krzywej Grzewczej</h2>

                <!-- T zewn. baza (Base outside) -->
                <div>
                    <label for="T_zew_baza" class="block text-sm font-medium text-gray-700">T zewn. baza [°C] (np. 20)</label>
                    <input type="number" id="T_zew_baza" value="20" min="-50" max="50" step="1"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 border transition duration-150 ease-in-out focus:border-blue-500 focus:ring-blue-500">
                    <p class="text-xs text-gray-500 mt-1">Temp. zewn., przy której zaczynamy grzanie.</p>
                </div>

                <!-- T zasilania baza (Base flowtemp) -->
                <div>
                    <label for="T_zas_baza" class="block text-sm font-medium text-gray-700">T zasilania baza [°C] (np. 20)</label>
                    <input type="number" id="T_zas_baza" value="20" min="5" max="90" step="1"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 border transition duration-150 ease-in-out focus:border-blue-500 focus:ring-blue-500">
                    <p class="text-xs text-gray-500 mt-1">Temp. wody dla T zewn. baza. Ustawiona na 20°C dla maks. oszczędności.</p>
                </div>

                <!-- T zewn. klimatu (Climate outside) -->
                <div>
                    <label for="T_zew_klimat" class="block text-sm font-medium text-gray-700">T zewn. klimatu [°C] (np. -20)</label>
                    <input type="number" id="T_zew_klimat" value="-20" min="-50" max="50" step="1"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 border transition duration-150 ease-in-out focus:border-blue-500 focus:ring-blue-500">
                    <p class="text-xs text-gray-500 mt-1">Temp. zewn. dla najostrzejszej zimy.</p>
                </div>

                <!-- T zasilania klimatu (Climate flowtemp) -->
                <div>
                    <label for="T_zas_klimat" class="block text-sm font-medium text-gray-700">T zasilania klimatu [°C] (np. 55)</label>
                    <input type="number" id="T_zas_klimat" value="55" min="5" max="90" step="1"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 border transition duration-150 ease-in-out focus:border-blue-500 focus:ring-blue-500">
                    <p class="text-xs text-gray-500 mt-1">Maks. temp. wody w grzejnikach. **55°C** jest idealne dla kondensacji.</p>
                </div>

                <div class="pt-4">
                    <button onclick="drawCurve()" class="w-full bg-blue-600 text-white py-2.5 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 font-bold">
                        Wygeneruj Krzywą
                    </button>
                </div>
            </div>

            <!-- Legenda i Wynik (Nachylenie) -->
            <div class="lg:col-span-2 space-y-4">
                <h2 class="text-xl font-semibold text-blue-700 border-b pb-2 mb-4">Wynik i Obliczone Nachylenie</h2>

                <div class="flex flex-wrap gap-4">
                    <div class="p-4 bg-yellow-50 rounded-lg shadow-inner flex-1 min-w-[45%]">
                        <p class="text-sm font-medium text-gray-500">Nachylenie krzywej (Slope)</p>
                        <p id="slope_output" class="text-2xl font-bold text-red-600">N/A</p>
                    </div>
                    <div class="p-4 bg-green-50 rounded-lg shadow-inner flex-1 min-w-[45%]">
                        <p class="text-sm font-medium text-gray-500">Komentarz (Wg. De Dietrich)</p>
                        <p id="comment_output" class="text-base font-semibold text-green-700">N/A</p>
                    </div>
                </div>

                <div class="p-4 bg-gray-100 rounded-lg shadow-inner">
                    <p class="text-sm font-medium text-gray-700 mb-2">Instrukcja odczytu wykresu:</p>
                    <ul class="text-sm text-gray-600 list-disc pl-5 space-y-1">
                        <li>**Oś X (Pozioma):** Temperatura Zewnętrzna [°C].</li>
                        <li>**Oś Y (Pionowa):** Temperatura Wody Zasilania [°C] (jakiej żąda kocioł).</li>
                        <li>Dla każdej temperatury na zewnątrz, kocioł dobierze odpowiednią, zadaną temperaturę wody.</li>
                        <li>Im niższa i bardziej płaska krzywa, tym ekonomiczniej pracuje kocioł kondensacyjny.</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Sekcja Wykresu Canvas -->
        <div class="bg-white p-6 rounded-xl shadow-2xl">
            <div class="chart-container">
                <canvas id="heatingCurveChart"></canvas>
            </div>
        </div>

        <p class="text-center text-xs text-gray-400 mt-6">
            Wizualizator oparty na zasadzie obliczania nachylenia i dwóch punktów bazowych.
        </p>
    </div>

    <script>
        let heatingCurveChart;

        /**
         * Funkcja obliczająca i wizualizująca krzywą grzewczą.
         * Krzywa grzewcza jest linią prostą łączącą dwa punkty:
         * P1 (T_zew_baza, T_zas_baza)
         * P2 (T_zew_klimat, T_zas_klimat)
         */
        function drawCurve() {
            // Pobranie wartości z pól
            const T_zew_baza = parseFloat(document.getElementById('T_zew_baza').value);
            const T_zas_baza = parseFloat(document.getElementById('T_zas_baza').value);
            const T_zew_klimat = parseFloat(document.getElementById('T_zew_klimat').value);
            const T_zas_klimat = parseFloat(document.getElementById('T_zas_klimat').value);

            const slopeOutput = document.getElementById('slope_output');
            const commentOutput = document.getElementById('comment_output');

            // POPRAWIONA WALIDACJA DANYCH
            // Sprawdzamy tylko, czy temperatura zasilania w klimacie (w mrozy) jest wyższa niż w bazie (w cieple).
            if (T_zas_baza >= T_zas_klimat) {
                slopeOutput.textContent = 'BŁĄD DANYCH';
                commentOutput.textContent = 'T zasilania klimatu (maks. temp. w mrozy) musi być wyższa niż T zasilania baza.';
                commentOutput.className = 'text-base font-semibold text-red-700';
                return;
            }

            // Walidacja drugiego, rzadkiego warunku - T zewn. klimatu musi być zimniejsze niż baza
            if (T_zew_baza <= T_zew_klimat) {
                slopeOutput.textContent = 'BŁĄD DANYCH';
                commentOutput.textContent = 'T zewn. baza musi być wyższa (cieplejsza) niż T zewn. klimatu (mrozy). Zmień T zewn. klimatu na niższą.';
                commentOutput.className = 'text-base font-semibold text-red-700';
                return;
            }

            // 1. Obliczenie nachylenia (Slope - m)
            // m = (y2 - y1) / (x1 - x2)  <-- dla krzywej grzewczej
            // m = (T_zas_klimat - T_zas_baza) / (T_zew_baza - T_zew_klimat)
            const slope = (T_zas_klimat - T_zas_baza) / (T_zew_baza - T_zew_klimat);
            slopeOutput.textContent = slope.toFixed(2);

            let comment;
            let commentClass = 'text-base font-semibold ';

            if (slope < 0.8) {
                comment = 'Bardzo płaska krzywa. Idealna dla Ogrzewania Podłogowego (poniżej 0.7).';
                commentClass += 'text-yellow-600';
            } else if (slope < 1.5) {
                comment = 'Płaska krzywa. Dobra dla dużych, nowoczesnych grzejników lub niskotemperaturowego systemu.';
                commentClass += 'text-green-700';
            } else if (slope <= 2.0) {
                comment = 'Standardowa krzywa dla grzejników. Typowe i efektywne (1.5-2.0).';
                commentClass += 'text-green-700';
            } else {
                comment = 'Stroma krzywa. Typowa dla małych grzejników lub słabej izolacji (mniej ekonomiczna).';
                commentClass += 'text-red-600';
            }
            commentOutput.textContent = comment;
            commentOutput.className = commentClass;


            // 2. Generowanie punktów dla wykresu
            const dataPoints = [];
            const tempRange = [-20, 20]; // Zakres T zewn. na wykresie

            for (let T_zew = tempRange[0]; T_zew <= tempRange[1]; T_zew += 1) {
                // Równanie prostej: y = y1 + m * (x1 - x)
                // T_zas = T_zas_baza + slope * (T_zew_baza - T_zew)
                let T_zas = T_zas_baza + slope * (T_zew_baza - T_zew);

                // Ograniczenie temperatury zasilania do max. wartości klimatu
                if (T_zas > T_zas_klimat) {
                    T_zas = T_zas_klimat;
                }
                
                // Ograniczenie dolne (jeśli T_zas będzie mniejsze niż T_zas_baza) - piec nie grzeje poniżej temp zadanej
                if (T_zas < T_zas_baza) {
                    T_zas = T_zas_baza;
                }

                dataPoints.push({ x: T_zew, y: T_zas });
            }

            // Dodajemy punkty bazowe, aby były widoczne (dla czystości kodu Chart.js)
            const basePoints = [
                { x: T_zew_baza, y: T_zas_baza },
                { x: T_zew_klimat, y: T_zas_klimat }
            ];

            // 3. Rysowanie wykresu Chart.js
            const ctx = document.getElementById('heatingCurveChart').getContext('2d');

            const chartData = {
                datasets: [
                    {
                        label: 'Krzywa Grzewcza (T Zasilania)',
                        data: dataPoints,
                        borderColor: '#1e40af', // blue-800
                        backgroundColor: 'rgba(30, 64, 175, 0.1)',
                        borderWidth: 3,
                        pointRadius: 0,
                        fill: false,
                        tension: 0, // Prosta linia
                        showLine: true,
                        parsing: { xAxisKey: 'x', yAxisKey: 'y' }
                    },
                    {
                        label: 'Punkt Bazowy (Start Grzania)',
                        data: [{ x: T_zew_baza, y: T_zas_baza }],
                        backgroundColor: '#f59e0b', // amber-500
                        pointRadius: 8,
                        pointHoverRadius: 10,
                        type: 'scatter',
                    },
                    {
                        label: 'Punkt Klimatu (Maks. Grzanie)',
                        data: [{ x: T_zew_klimat, y: T_zas_klimat }],
                        backgroundColor: '#b91c1c', // red-700
                        pointRadius: 8,
                        pointHoverRadius: 10,
                        type: 'scatter',
                    }
                ]
            };

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            title: (context) => `T Zewn: ${context[0].parsed.x}°C`,
                            label: (context) => `T Zasilania: ${context.parsed.y.toFixed(1)}°C`
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Temperatura Zewnętrzna [°C]',
                            color: '#374151',
                            font: { size: 14, weight: 'bold' }
                        },
                        type: 'linear',
                        position: 'bottom',
                        min: tempRange[0],
                        max: T_zew_baza > tempRange[1] ? T_zew_baza + 5 : tempRange[1],
                        grid: { color: 'rgba(0, 0, 0, 0.05)' }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Temperatura Wody Zasilania [°C]',
                            color: '#374151',
                            font: { size: 14, weight: 'bold' }
                        },
                        min: 10,
                        max: T_zas_klimat < 70 ? 70 : T_zas_klimat + 10, // Dynamiczna skala
                        grid: { color: 'rgba(0, 0, 0, 0.05)' }
                    }
                }
            };

            if (heatingCurveChart) {
                heatingCurveChart.destroy();
            }

            heatingCurveChart = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: chartOptions
            });
        }

        // Rysowanie wykresu przy załadowaniu strony z domyślnymi parametrami
        window.onload = function() {
            drawCurve();
        };

        // Nasłuchiwanie zmian w polach formularza i automatyczne odświeżanie
        document.getElementById('T_zew_baza').addEventListener('change', drawCurve);
        document.getElementById('T_zas_baza').addEventListener('change', drawCurve);
        document.getElementById('T_zew_klimat').addEventListener('change', drawCurve);
        document.getElementById('T_zas_klimat').addEventListener('change', drawCurve);

    </script>
</body>
</html>